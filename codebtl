ï»¿#include <stdio.h>
#include <stdlib.h>
#include <string.h>

typedef struct SinhVien
{
    char hoTen[50];
    char mssv[20];
    char lopHoc[20];
    float GPA;
    struct SinhVien* next;
} SinhVien;

SinhVien* head;  // Danh sÃ¡ch sinh viÃªn gá»‘c

void xoa_xuong_dong(char x[]);
const char* layTen(const char* hoTen);

void ghi_file(const char* tenFile);
void doc_file(const char* tenFile);

void nhap_mot_sinh_vien(SinhVien* sv);
void them_sinh_vien(SinhVien svMoi);
void hien_thi_danh_sach(SinhVien* head);
void xoa_sinh_vien(char mssv[]);
void sua_thong_tin(char mssv[]);
void thong_ke(SinhVien* danh_sach);

SinhVien* tim_theo_mssv(char mssv[]);
void hien_thi_diem_cao_nhat(SinhVien* head);
void tim_theo_khoang_diem(float min, float max);

void sap_xep_theo_ten(SinhVien* head);
void sap_xep_theo_gpa(SinhVien* head);

void menu_sap_xep();
void menu_tim_kiem();
int menu();

int main() {

    doc_file("DANHSACHNHOM9.txt");
    hien_thi_danh_sach(head);

    int luaChon;
    char mssv[20], tenFile[100];
    SinhVien svMoi;

    do {

        luaChon = menu();  // Gá»i hÃ m menu Ä‘á»ƒ in vÃ  láº¥y lá»±a chá»n

        switch (luaChon) {
        case 1:
            hien_thi_danh_sach(head);
            break;
        case 2:
            nhap_mot_sinh_vien(&svMoi);
            them_sinh_vien(svMoi);
            hien_thi_danh_sach(head);
            break;
        case 3:
            printf("Nhap MSSV can sua: ");
            scanf("%s", mssv);
            getchar();
            sua_thong_tin(mssv);
            hien_thi_danh_sach(head);
            break;
        case 4:
            printf("Nhap MSSV can xoa: ");
            scanf("%s", mssv);
            getchar();
            xoa_sinh_vien(mssv);
            hien_thi_danh_sach(head);
            break;
        case 5:
            menu_tim_kiem();
            break;
        case 6:
            menu_sap_xep();
            break;
        case 7:
            thong_ke(head);
            break;
        case 8:
            printf("Nhap ten file can luu: ");
            scanf("%s", tenFile);
            ghi_file(tenFile);
            break;
        case 9:
            // Sau nÃ y thÃªm hÃ m xuáº¥t há»c lá»±c náº¿u cáº§n
            break;
        case 0:
            printf("Thoat chuong trinh.\n");
            break;
        default:
            printf("Lua chon khong hop le.\n");
        }

    } while (luaChon != 0);

    return 0;
}
void xoa_xuong_dong(char x[]) {
    size_t len = strlen(x);      //tÃ­nh Ä‘á»™ dÃ i chuá»—i khÃ´ng tÃ­nh /0
    if (len > 0 && x[len - 1] == '\n') {
        x[len - 1] = '\0';
    }
}
//HÃ m loáº¡i bá» há» vÃ  tÃªn Ä‘á»‡m,
const char* layTen(const char* hoTen) {
    const char* ten = strrchr(hoTen, ' ');
    return (ten != NULL) ? ten + 1 : hoTen;
}


void doc_file(const char* tenFile) {
    FILE* f = fopen(tenFile, "r");
    if (f == NULL) {
        printf("Khong mo duoc file.\n");
        return;
    }

    char dong[200];
    SinhVien sv;
    while (fgets(dong, sizeof(dong), f)) {
        xoa_xuong_dong(dong);
        sscanf(dong, "%[^;];%[^;];%[^;];%f", sv.mssv, sv.hoTen, sv.lopHoc, &sv.GPA);
        them_sinh_vien(sv);
    }

    fclose(f);
}
void ghi_file(const char* tenFile) {
    FILE* f = fopen(tenFile, "w");
    if (f == NULL) {
        printf("Khong mo duoc file de ghi.\n");
        return;
    }

    SinhVien* p = head;
    while (p != NULL) {
        fprintf(f, "%s;%s;%s;%.2f\n", p->mssv, p->hoTen, p->lopHoc, p->GPA);
        p = p->next;
    }

    fclose(f);
    printf("Da ghi file thanh cong!\n");
}


void nhap_mot_sinh_vien(SinhVien* sv) {

    printf("Nhap MSSV: ");
    fgets(sv->mssv, 50, stdin);
    xoa_xuong_dong(sv->mssv);

    printf("Nhap ho ten: ");
    fgets(sv->hoTen, 20, stdin);
    xoa_xuong_dong(sv->hoTen);

    printf("Nhap lop hoc: ");
    fgets(sv->lopHoc, 20, stdin);
    xoa_xuong_dong(sv->lopHoc);

    printf("Nhap diem GPA: ");
    scanf("%f", &sv->GPA);
    getchar();

    sv->next = NULL; // Khá»Ÿi táº¡o con trá» next lÃ  NULL xem node cuá»‘i danh sÃ¡ch
}
void them_sinh_vien(SinhVien svMoi) {
    SinhVien* nodeMoi = (SinhVien*)malloc(sizeof(SinhVien));
    *nodeMoi = svMoi;
    nodeMoi->next = NULL;

    if (head == NULL || strcmp(svMoi.mssv, head->mssv) < 0) {
        nodeMoi->next = head;
        head = nodeMoi;
    }
    else {
        SinhVien* p = head;
        while (p->next != NULL && strcmp(p->next->mssv, svMoi.mssv) < 0) {
            p = p->next;
        }
        nodeMoi->next = p->next;
        p->next = nodeMoi;
    }
}
void hien_thi_danh_sach(SinhVien* head) {
    SinhVien* p = head;// Duyá»‡t tá»« Ä‘áº§u danh sÃ¡ch

    if (p == NULL) {
        printf("Danh sach rong.\n");
        return;
    }

    printf("+------------+-------------------------------+---------------+--------+\n");
    printf("|   MSSV     |           Ho ten              |   Lop hoc     |  Diem  |\n");
    printf("+------------+-------------------------------+---------------+--------+\n");

    while (p != NULL) {
        printf("| %-10s | %-29s | %-13s | %6.2f |\n", p->mssv, p->hoTen, p->lopHoc, p->GPA);
        printf("+------------+-------------------------------+---------------+--------+\n");
        p = p->next;
    }
}
void xoa_sinh_vien(char mssv[]) {
    SinhVien* p = head;
    SinhVien* truoc = NULL; //con trá» Ä‘á»ƒ lÆ°u pháº§n tá»­ trÆ°á»›c pháº§n tá»­ hiá»‡n táº¡i

    while (p != NULL && strcmp(p->mssv, mssv) != 0) {
        truoc = p;
        p = p->next;
    }

    if (p == NULL) {
        printf("Khong tim thay MSSV %s\n", mssv);
        return;
    }

    if (truoc == NULL) head = p->next;
    else truoc->next = p->next;

    free(p);
}
void sua_thong_tin(char mssv[]) {
    SinhVien* sv = tim_theo_mssv(mssv);
    if (sv == NULL) {
        printf("Khong tim thay MSSV %s\n", mssv);
        return;
    }

    printf("Nhap ho ten: ");
    fgets(sv->hoTen, 20, stdin);
    xoa_xuong_dong(sv->hoTen);

    printf("Nhap lop hoc: ");
    fgets(sv->lopHoc, 20, stdin);
    xoa_xuong_dong(sv->lopHoc);

    printf("Nhap diem GPA: ");
    scanf("%f", &sv->GPA);
    getchar();
}
void thong_ke(SinhVien* danh_sach) {
    if (danh_sach == NULL) {
        printf("Danh sach rong.\n");
        return;
    }

    int tong_sv = 0, gioi = 0, kha = 0, tb = 0, kem = 0;
    float tong_gpa = 0.0;
    float gpa_max = -1.0;
    SinhVien* sv_max = NULL;

    SinhVien* p = danh_sach;
    while (p != NULL) {
        tong_sv++;
        tong_gpa += p->GPA;

        // PhÃ¢n loáº¡i
        if (p->GPA >= 8.0)
            gioi++;
        else if (p->GPA >= 6.5)
            kha++;
        else if (p->GPA >= 5.0)
            tb++;
        else
            kem++;

        // Äiá»ƒm cao nháº¥t
        if (p->GPA > gpa_max) {
            gpa_max = p->GPA;
            sv_max = p;
        }

        p = p->next;
    }

    float gpa_tb = tong_gpa / tong_sv;

    printf("\n=== THONG KE LOP HOC ===\n");
    printf("So sinh vien: %d\n", tong_sv);
    printf("GPA trung binh ca lop: %.2f\n", gpa_tb);
    printf("Sinh vien gioi: %d (%.2f%%)\n", gioi, (float)gioi / tong_sv * 100);
    printf("Sinh vien kha : %d (%.2f%%)\n", kha, (float)kha / tong_sv * 100);
    printf("Sinh vien TB  : %d (%.2f%%)\n", tb, (float)tb / tong_sv * 100);
    printf("Sinh vien kem : %d (%.2f%%)\n", kem, (float)kem / tong_sv * 100);

    if (sv_max != NULL) {
        printf("\n Sinh vien diem cao nhat:\n");
        printf("MSSV: %s\t", sv_max->mssv);
        printf("Ho ten: %s\t", sv_max->hoTen);
        printf("GPA: %.2f\n", sv_max->GPA);
    }
}


SinhVien* tim_theo_mssv(char mssv[]) {
    SinhVien* p = head;
    while (p != NULL) {
        if (strcmp(p->mssv, mssv) == 0) {
            return p;  // Tráº£ vá» Ä‘á»‹a chá»‰ node tÃ¬m Ä‘Æ°á»£c
        }
        p = p->next;
    }
    return NULL; // KhÃ´ng tÃ¬m tháº¥y thÃ¬ tráº£ NULL
}
void hien_thi_diem_cao_nhat(SinhVien* head) {
    if (head == NULL) {
        printf("Danh sach rong.\n");
        return;
    }

    float maxGPA = head->GPA;
    SinhVien* p = head->next;

    // TÃ¬m GPA cao nháº¥t
    while (p != NULL) {
        if (p->GPA > maxGPA) {
            maxGPA = p->GPA;
        }
        p = p->next;
    }

    // Kiá»ƒm tra cÃ³ sinh viÃªn nÃ o cÃ³ GPA cao nháº¥t khÃ´ng
    if (maxGPA == 0) {
        printf("Khong co sinh vien co GPA cao.\n");
        return;
    }

    // In cÃ¡c SV cÃ³ GPA cao nháº¥t
    printf("\nCac sinh vien co GPA cao nhat (%.2f):\n", maxGPA);
    printf("+------------+-------------------------------+---------------+--------+\n");
    printf("|   MSSV     |           Ho ten              |   Lop hoc     |  Diem  |\n");
    printf("+------------+-------------------------------+---------------+--------+\n");

    p = head;
    int found = 0;  // Biáº¿n kiá»ƒm tra náº¿u cÃ³ sinh viÃªn nÃ o cÃ³ GPA cao nháº¥t
    while (p != NULL) {
        if (p->GPA == maxGPA) {
            printf("| %-10s | %-29s | %-13s | %6.2f |\n",
                p->mssv, p->hoTen, p->lopHoc, p->GPA);
            found = 1;
        }
        p = p->next;
    }

    if (!found) {
        printf("Khong tim thay sinh vien co GPA cao nhat.\n");
    }
    else {
        printf("+------------+-------------------------------+---------------+--------+\n");
    }
}
void tim_theo_khoang_diem(float min, float max) {
    int found = 0;
    SinhVien* p = head;

    printf("\nCac sinh vien co GPA trong khoang %.2f - %.2f:\n", min, max);
    printf("+------------+-------------------------------+---------------+--------+\n");
    printf("|   MSSV     |           Ho ten              |   Lop hoc     |  Diem  |\n");
    printf("+------------+-------------------------------+---------------+--------+\n");

    while (p != NULL) {
        if (p->GPA >= min && p->GPA <= max) {
            found = 1;
            printf("| %-10s | %-29s | %-13s | %6.2f |\n",
                p->mssv, p->hoTen, p->lopHoc, p->GPA);
            printf("+------------+-------------------------------+---------------+--------+\n");
        }
        p = p->next;
    }

    if (!found) {
        printf("Khong co sinh vien nao trong khoang diem nay.\n");
    }
}


void sap_xep_theo_ten(SinhVien* head) {
    if (head == NULL || head->next == NULL) return;

    SinhVien* i, * j;
    for (i = head; i != NULL; i = i->next) {
        for (j = i->next; j != NULL; j = j->next) {
            if (strcmp(layTen(i->hoTen), layTen(j->hoTen)) > 0) {
                // HoÃ¡n Ä‘á»•i dá»¯ liá»‡u
                char tempHoTen[100];
                strcpy(tempHoTen, i->hoTen);
                strcpy(i->hoTen, j->hoTen);
                strcpy(j->hoTen, tempHoTen);
                // (ThÃªm hoÃ¡n Ä‘á»•i cÃ¡c trÆ°á»ng khÃ¡c náº¿u cáº§n, nhÆ° MSSV, Ä‘iá»ƒm,...)
            }
        }
    }
}
void sap_xep_theo_gpa(SinhVien* head) {
    if (head == NULL || head->next == NULL) return;

    SinhVien* i, * j;
    for (i = head; i != NULL; i = i->next) {
        for (j = i->next; j != NULL; j = j->next) {
            if (i->GPA < j->GPA) {
                // HoÃ¡n Ä‘á»•i 
                SinhVien temp = *i;
                *i = *j;
                *j = temp;

                // Giá»¯ liÃªn káº¿t Ä‘Ãºng
                SinhVien* tmpNext = i->next;
                i->next = j->next;
                j->next = tmpNext;
            }
        }
    }
}


// HÃ m menu con: TÃ¬m kiáº¿m
void menu_tim_kiem() {
    int chon;
    char mssv[20];
    float min, max;

    do {
        printf("\n===== MENU TIM KIEM =====\n");
        printf("1. Tim theo MSSV\n");
        printf("2. Tim diem cao nhat\n");
        printf("3. Tim theo khoang diem\n");
        printf("4. Quay lai menu chinh\n");
        printf("Chon: ");
        scanf("%d", &chon);

        switch (chon) {
        case 1: {
            printf("Nhap MSSV: ");
            scanf("%s", mssv); getchar();
            SinhVien* sv = tim_theo_mssv(mssv);
            if (sv) {
                hien_thi_danh_sach(sv);
            }
            else {
                printf("Khong tim thay sinh vien.\n");
            }
            break;
        }
        case 2:
            hien_thi_diem_cao_nhat(head);
            break;
        case 3:
            printf("Nhap diem min: ");
            scanf("%f", &min);
            printf("Nhap diem max: ");
            scanf("%f", &max);
            tim_theo_khoang_diem(min, max);
            break;
        case 4:
            return;
        default:
            printf("Lua chon khong hop le.\n");
        }
    } while (chon != 4);
}
// HÃ m menu con: Sáº¯p xáº¿p
void menu_sap_xep() {
    int chon;

    do {
        printf("\n===== MENU SAP XEP =====\n");
        printf("1. Sap xep theo ten\n");
        printf("2. Sap xep theo GPA (Max -> Min)\n");
        printf("3. Quay lai menu chinh\n");
        printf("Chon: ");
        scanf("%d", &chon);

        switch (chon) {
        case 1:
            sap_xep_theo_ten(head);
            hien_thi_danh_sach(head);
            break;
        case 2:
            sap_xep_theo_gpa(head);
            hien_thi_danh_sach(head);
            break;
        case 3:
            return;
        default:
            printf("Lua chon khong hop le.\n");
        }
    } while (chon != 3);
}
// HÃ m Ä‘á»ƒ in cÃ¡c chá»©c nÄƒng vÃ  láº¥y lá»±a chá»n
int menu() {
    int luaChon;
    printf("\n===== MENU QUAN LY SINH VIEN =====\n");
    printf("1. In danh sach sinh vien \n");
    printf("2. Them sinh vien\n");
    printf("3. Sua sinh vien\n");
    printf("4. Xoa sinh vien\n");
    printf("5. Tim kiem\n");
    printf("6. Sap xep\n");
    printf("7. Thong ke\n");
    printf("8. Sao luu (file)\n");
    printf("0. Thoat\n");
    printf("Chon: ");
    scanf("%d", &luaChon);
    getchar();
    return luaChon;
}
